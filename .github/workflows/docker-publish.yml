---
    name: Docker Build and Publish
    
    on:
      release:
        types: [created]
      workflow_dispatch:  # Allows manual trigger
    
    jobs:
      build-and-push:
        name: Build and Push Docker image
        runs-on: ubuntu-latest
        
        steps:
          - name: Check out the repo
            uses: actions/checkout@v3
          
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v2
          
          - name: Log in to Docker Hub
            uses: docker/login-action@v2
            with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}
          
          - name: Extract metadata (tags, labels) for Docker
            id: meta
            uses: docker/metadata-action@v4
            with:
              images: malithrukshan/geoip-api
              tags: |
                type=raw,value=latest,enable=${{ github.ref == 
                  format('refs/heads/{0}', 'main') || startsWith(github.ref, 'refs/tags/') }}
                type=semver,pattern={{version}},enable=${{ 
                  startsWith(github.ref, 'refs/tags/') }}
          
          - name: Build and push Docker image
            uses: docker/build-push-action@v4
            with:
              context: .
              push: true
              tags: ${{ steps.meta.outputs.tags }}
              labels: ${{ steps.meta.outputs.labels }}
              platforms: linux/amd64,linux/arm64
              cache-from: type=gha
              cache-to: type=gha,mode=max
          
          - name: Update Docker Hub Description
            uses: peter-evans/dockerhub-description@v3
            with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}
              repository: malithrukshan/geoip-api
              short-description: >-
                Self-hosted IP geolocation API that works completely offline!
              readme-filepath: ./README.md